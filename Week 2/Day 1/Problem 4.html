<!DOCTYPE html>
<html>
<head>
    <title>Mini Expense Tracker</title>
    <style>
        body { font-family: Arial; }
        .error { color: red; }
        .success { color: green; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
    </style>
    </head>
    <body>
        <h2> Expense Tracker (IndexedDB)</h2>

        <label> Title: </label>
        <input type="text" id="title"><br><br>

        <label> Amount: </label>
        <input type="number" id="amount"><br><br>

        <label> Date: </label>
        <input type="date" id="date"><br><br>

        <button onclick="addExpense()">Add Expense </button>
        <button onclick="displayExpenses()"> Display Expenses </button>

        <div id = "errorMessage" class = "error"></div>

        <table id = "expenseTable">
            <thead>
            <tr>
                <th> ID </th>
                <th> Title </th>
                <th> Amount </th>
                <th> Date </th>
                <th> Action </th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script>

        let db;

        // ====================== DATABSE SETUP ======================
        let request = indexedDB.open("ExpenseDB", 1);

        request.onerror = function(event) {
            document.getElementById("errorMessage").innerText =
                "Database failed to open.";
        };

        request.onsuccess = function(event) {
            db = event.target.result;
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;

            // CREATE TABLE (Object Store)
            let objectStore = db.createObjectStore("expenses", {
                keyPath: "id",
                autoIncrement: true
            });
        };


       // ================== ADD EXPENSE (INSERT) ==================

        function addExpense() {

            if(!db) {
                return;
            }

            let title = document.getElementById("title").value;
            let amount = document.getElementById("amount").value;
            let date = document.getElementById("date").value;

            if(title === "" || amount === "" || date === "") {
                alert("All fields required!");
                return;
            }

            let transaction = db.transaction(["expenses"], "readwrite");

            transaction.onerror = function() {
                alert("Transaction failed!");
            };

            let store = transaction.objectStore("expenses");

            let expense = {
                title: title,
                amount: amount,
                date: date
            };

            store.add(expense);

            transaction.oncomplete = function() {
                alert("Expense Added Successfully!");
                displayExpenses();
            };
        }

        // ================== DISPLAY EXPENSES (SELECT) ==================

        function displayExpenses() {

            if (!db) return;
            
            let transaction = db.transaction(["expenses"], "readonly");
            let store = transaction.objectStore("expenses");

            let request = store.getAll();

            request.onsuccess = function() {

                let expenses = request.result;
                let tbody = document.querySelector("#expenseTable tbody");

                tbody.innerHTML = "";

                expenses.forEach(function(expense) {

                    let row = document.createElement("tr");

                    row.innerHTML =
                        "<td>" + expense.id + "</td>" +
                        "<td>" + expense.title + "</td>" +
                        "<td>" + expense.amount + "</td>" +
                        "<td>" + expense.date + "</td>" +
                        "<td><button onclick='deleteExpense(" + expense.id + ")'>Delete</button></td>";

                    tbody.appendChild(row);
                });
            };
        }

        // ================== DELETE EXPENSE ==================

        function deleteExpense(id) {

            let transaction = db.transaction(["expenses"], "readwrite");
            let store = transaction.objectStore("expenses");

            store.delete(id);

            transaction.oncomplete = function() {
                displayExpenses();
            };
    }

            

        </script>
    </body>
</html>